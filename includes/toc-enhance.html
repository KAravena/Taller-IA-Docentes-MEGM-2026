<script>
document.addEventListener("DOMContentLoaded", () => {
  const toc = document.querySelector("nav#TOC, nav.toc-active");
  if (!toc) return;

  const tocLinks = toc.querySelectorAll("a.nav-link[data-scroll-target]");
  if (!tocLinks.length) return;

  const getTarget = (link) => {
    const rawTarget = link.getAttribute("data-scroll-target") || "";
    if (!rawTarget) return null;

    const targetId = rawTarget.startsWith("#") ? rawTarget.slice(1) : rawTarget;
    if (!targetId) return null;

    const byId = document.getElementById(targetId);
    if (byId) return byId;

    if (window.CSS && typeof window.CSS.escape === "function") {
      try {
        return document.querySelector(`#${CSS.escape(targetId)}`);
      } catch (err) {
        return null;
      }
    }

    try {
      return document.querySelector(rawTarget);
    } catch (err) {
      return null;
    }
  };

  const sections = Array.from(tocLinks)
    .map((link) => {
      const target = getTarget(link);
      return target ? { link, target, top: 0 } : null;
    })
    .filter(Boolean);

  const updateOffsets = () => {
    sections.forEach((section) => {
      section.top = section.target.getBoundingClientRect().top + window.scrollY;
    });
  };

  const activateLink = (targetLink) => {
    tocLinks.forEach((link) => link.classList.remove("active"));
    if (targetLink) targetLink.classList.add("active");
  };

  const OFFSET = 140;
  let ticking = false;

  const updateActiveSection = () => {
    const scrollPosition = window.scrollY + OFFSET;
    let current = sections[0];
    for (const section of sections) {
      if (section.top <= scrollPosition) {
        current = section;
      } else {
        break;
      }
    }
    activateLink(current ? current.link : null);
    ticking = false;
  };

  const onScroll = () => {
    if (!ticking) {
      window.requestAnimationFrame(updateActiveSection);
      ticking = true;
    }
  };

  updateOffsets();
  updateActiveSection();

  window.addEventListener("scroll", onScroll, { passive: true });
  window.addEventListener("resize", () => {
    updateOffsets();
    updateActiveSection();
  });
  window.addEventListener("hashchange", () => {
    const hash = window.location.hash;
    const match = sections.find((section) => section.link.getAttribute("data-scroll-target") === hash);
    if (match) activateLink(match.link);
  });

  // Estilo responsivo: sin scroll horizontal y ocupando ancho disponible
  const style = document.createElement("style");
  style.innerHTML = `
    /* Que el TOC use todo el ancho disponible y nunca genere scroll horizontal */
    nav#TOC, nav.toc-active {
      width: 100%;
      max-width: none;
      min-width: 0;
      padding-right: 1rem;
      box-sizing: border-box;
      overflow-x: hidden !important;
    }
    nav#TOC *, nav.toc-active * {
      max-width: 100%;
      white-space: normal !important;
      overflow-wrap: anywhere;
      word-break: break-word;
    }
    nav#TOC .toc-entry a, nav.toc-active .toc-entry a {
      line-height: 1.4;
    }
  `;
  document.head.appendChild(style);
});
</script>
